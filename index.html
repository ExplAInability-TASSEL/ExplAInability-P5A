---
---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koumbia Map</title>
    <!-- CSS, mise en page -->
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        /* carte de base */
        #map-container {
            position: absolute;
            top: 40px;
            left: 0;
            width: 100%;
            height: calc(100% - 40px);
        }
        /* menu en haut (menu info contact) */
        #nav-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background-color: #333; /* Background color for the navigation menu */
            color: #fff; /* Text color for the menu items */
            z-index: 999;
        }
        /* liste des 3 element menus info et contact */
        #nav-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
        }
        /* chaque element de la liste de la barre */
        #nav-menu li {
            padding: 10px 20px;
            cursor: pointer;
        }
        /* panel segment à droite */
        #info-panel {
            position: absolute;
            top: 40px;
            right: 0;
            width: 40%;
            height: 100%;
            background-color: #fff;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.5);
            transform: translateX(100%); /* Adjusted initial position */
            display: flex;
            flex-direction: column;
        }
        /* petite fleche du panel */
        #info-panel-arrow {
            position: absolute;
            top: 50%;
            left: -20px; /* Adjusted left position to the left side of the panel */
            transform: translateY(-50%) rotate(90deg); /* Rotated to face right */
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #3a1414;
            cursor: pointer;
        }
        /* map google API dans le panel*/
        #map-in-panel {
            width: 100%;
            height: calc(100% - 80px);
        }
        /* bandeau info segment ID */
        #info-content {
        width: 100%;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #fff;
        }
        /* segment ID définit plus bas, on enlève la marge */
        #info-content h3 {
            margin: 0;
        }
        /* legend de la heatmap -> barre blanche en bas */
        #legend {
            width: 100%;
            height: 180px; /* Hauteur de la légende */
            background-color: #fff;
            position: relative; /* Position relative pour placer les éléments internes absolus */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        /* degradé de couleur barre de la heatmap */
        #gradient {
            width: 100%;
            height: 20px; /* Ajustez la hauteur selon vos besoins */
            background: linear-gradient(to right, #ff0000, #00ff00);
        }
        #legend-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 0px; /* Ajustez la marge selon vos besoins */
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- section menu de la page -->
    <div id="nav-menu">
        <ul>
            <!-- lien hypertextes qui renvoient vers les sections dont l'ID est #menu, #infos et #contact. A DEFINIR -->
            <li><a href="#menu" style="text-decoration: none; color: #fff;">Menu</a></li>
            <li><a href="#infos" style="text-decoration: none; color: #fff;">Infos</a></li>
            <li><a href="#contact" style="text-decoration: none; color: #fff;">Contact</a></li>
        </ul>
    </div>

    <!-- map  -->
    <div id="map-container"></div>

    <!-- panel qui apparait quand on clique sur segment -->
    <div id="info-panel">
        <div id="info-content">
            <!-- Data will be displayed here when an area is clicked -->
        </div>
        <div id="map-in-panel">
            <!-- New map will be displayed here when an area is clicked -->
        </div>
        <div id="legend">
            <!-- <div id="gradient"></div> -->
            <div id="legend-content">
                <!-- <h4>Heatmap LegendSS</h4> -->
                <div id="gradient"></div>
                <p>Intensity RangeSS: ${maxIntensity} - ${minIntensity}</p>
                <!-- Ajoutez d'autres éléments de légende selon vos besoins -->
            </div>
        </div>
        <div id="info-panel-arrow" onclick="toggleInfoPanel()"></div>
    </div>

    <script>
        let infoPanelVisible = false;
        let mapInPanel;
        let map;
        let heatmap;

        function toggleInfoPanel() {
            const infoPanel = document.getElementById("info-panel");
            infoPanelVisible = !infoPanelVisible;

            if (infoPanelVisible) {
                infoPanel.style.transform = "translateX(0)"; // Show the panel
            } else {
                infoPanel.style.transform = "translateX(100%)"; // Hide the panel
            }
        }



        // Function to dynamically convert alpha value to hsl color
        function getColorFromAlpha(alpha) {
            const hue = (1 - alpha) * 240; // Map alpha to hue (0: red, 120: green, 240: blue)
            const saturation = 5; // 100% saturation
            const lightness = 20; // 50% lightness

            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }




        // fonction qui est appelée lorsque l'API google map est chargée (javascript)
        function initMap() {
            // study area = 2000 km^2 in Burkina Faso around the town of Koumbia
            // objets avec les propriétés lat et lng
            var topLeft = {lat: 11.37, lng: -3.89};
            var topRight = {lat: 11.37, lng: -3.42};
            var bottomRight = {lat: 10.96, lng: -3.42};
            var bottomLeft = {lat: 10.96, lng: -3.89};

            // Calculer le centre de la bounding box
            var centerCoordinates = {
                lat: (topLeft.lat + bottomRight.lat) / 2,
                lng: (topLeft.lng + bottomRight.lng) / 2
            };

            // charger la carte
            map = new google.maps.Map(document.getElementById('map-container'), {
                zoom: 10,
                center: centerCoordinates
            });

            // Créer une forme de rectangle pour représenter la bounding box
            var boundingBox = new google.maps.Polygon({
                map: map,
                paths: [topLeft, topRight, bottomRight, bottomLeft],
                strokeColor: '#FF0000', // rouge
                strokeOpacity: 1,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.2
            });

            // recupérer les coordonnées des segments à partir du fichier JSON (requête fetch)
            fetch('./sources/final_segment_lat_long.json')
                // convertit la réponse en JSON
                .then(response => response.json())
                // traitement des données récupérées
                .then(data => {
                    // Loop through the data and create polygons for each area
                    data.forEach((areaData) => {
                        const polygonCoordinates = areaData.perimeter_pixel_coordinates.map(coord => ({
                            lat: parseFloat(coord.latitude),
                            lng: parseFloat(coord.longitude),
                            intensity: parseFloat(coord.intensity)
                        }));

                        // Create a polygon with ordered coordinates
                        const polygon = new google.maps.Polygon({
                            paths: polygonCoordinates,
                            map: map,
                        });

                        // Add click event listener to the polygon
                        polygon.addListener("click", () => {
                            const infoContent = `
                                <h3>Segment ID: ${areaData.segment_id}</h3>
                                <h3>Class ID: ${areaData.class_id}</h3>
                            `;
                            document.getElementById("info-content").innerHTML = infoContent; // affiche le segment ID dans info-panel -> info-content
                            toggleInfoPanel(); // Open or hide the panel when an area is clicked

                            // Récupérer les coordonnées du polygone cliqué
                            const polygonCoordinates = areaData.perimeter_pixel_coordinates.map(coord => ({
                                lat: parseFloat(coord.lat),
                                lng: parseFloat(coord.lng),
                                intensity: parseFloat(coord.intensity)
                            }));





                            // Loop through pixel_coordinates and display them on the map with alpha values from the alphas list
                            areaData.pixel_coordinates.forEach((pixelCoord, index) => {
                                const alpha = areaData.alphas[index];
                                const pixelMarker = new google.maps.Marker({
                                    position: new google.maps.LatLng(pixelCoord.latitude, pixelCoord.longitude),
                                    map: map,
                                    icon: {
                                        path: google.maps.SymbolPath.CIRCLE,
                                        fillColor: getColorFromAlpha(alpha),
                                        fillOpacity: 1,
                                        strokeWeight: 0,
                                        scale: 5 // Adjust the scale as needed
                                    }
                                });
                            });







                            // Calculer le centre géométrique du polygone
                            const centerLat = polygonCoordinates.reduce((sum, coord) => sum + coord.lat, 0) / polygonCoordinates.length;
                            const centerLng = polygonCoordinates.reduce((sum, coord) => sum + coord.lng, 0) / polygonCoordinates.length;

                            // Create a new map in the panel centered on the clicked area -> ON VEUT HEAT MAP
                            const mapOptions = {
                                center: new google.maps.LatLng(centerLat, centerLng),
                                zoom: 11,
                            };
                            mapInPanel = new google.maps.Map(document.getElementById("map-in-panel"), mapOptions);

                            // Initialize the heatmap layer
                            const heatmapData = polygonCoordinates.map(coord => ({
                                location: new google.maps.LatLng(coord.lat, coord.lng),
                                weight: coord.intensity
                            }));

                            // Add console.log for debugging
                            console.log('polygonCoordinates V1806:', polygonCoordinates);

                            heatmap = new google.maps.visualization.HeatmapLayer({
                                data: heatmapData,
                                dissipating: true,
                                radius: 50,
                                opacity: 0.7,
                                map: mapInPanel,
                            });
                            //heatmap.setMap(mapInPanel);

                            // Obtenir les valeurs minimale et maximale de l'intensité
                            const minIntensity = Math.min(...polygonCoordinates.map(coord => coord.intensity));
                            const maxIntensity = Math.max(...polygonCoordinates.map(coord => coord.intensity));

                            // Mise à jour de la légende
                            const legendContent = `
                                <h4>Heatmap Legend</h4>
                                <div id="gradient"></div>
                                <p>Intensity Range: ${maxIntensity} - ${minIntensity}</p>
                                <!-- Ajoutez d'autres informations de légende selon vos besoins -->
                            `;
                            document.getElementById("legend-content").innerHTML = legendContent;

                        });
                    });
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }

        
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ site.GOOGLE_MAP_API_KEY }}&callback=initMap" async defer></script>
</body>
</html>
